<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <script>
      document.addEventListener("DOMContentLoaded", async function() {

          await import("lib/shopify_app")


        var SessionToken = window["app-bridge"].actions.SessionToken
        var app = window.app;

        app.dispatch(
          SessionToken.request(),
        );

        // Save a session token for future requests
        window.sessionToken = await new Promise((resolve) => {
          app.subscribe(SessionToken.Action.RESPOND, (data) => {
            resolve(data.sessionToken || "");
          });
        });

        var fetchProducts = function() {
          var headers = new Headers({ "Authorization": "Bearer " + window.sessionToken });
          return fetch("/products", { headers })
            .then(response => response.json())
            .then(data => {
              var products = data.products;

              if (products === undefined || products.length == 0) {
                document.getElementById("products").innerHTML = "<br>No products to display.";
              } else {
                var list = "";
                products.forEach((product) => {
                  var link = `<a target="_top" href="https://<%= @shop_origin %>/admin/products/${product.id}">`
                  list += "<li>" + link + product.title + "</a></li>";
                });
                document.getElementById("products").innerHTML = "<ul>" + list + "</ul>";
              }
            });
        }();

        var bindAuditPagination = function() {
          $("#audits .pagination-link").click(function(e) {
            e.preventDefault();
            e.stopPropagation();
            var url = $(this).attr("href");
            fetchAudits(url);
          });
        };

        var fetchAudits = function(url = "/audits") {
          var headers = new Headers({ "Authorization": "Bearer " + window.sessionToken });
          return fetch(url, { headers })
            .then(response => response.text())
            .then(data => {
              document.getElementById("audits").innerHTML = data;
              bindAuditPagination();
            });
        };

        var bindWebhooksPagination = function() {
          $("#webhooks .pagination-link").click(function(e) {
            e.preventDefault();
            e.stopPropagation();
            var url = $(this).attr("href");
            fetchWebhooks(url);
          });
        };

        var fetchWebhooks = function(url = "/webhooks") {
          var headers = new Headers({ "Authorization": "Bearer " + window.sessionToken });
          return fetch(url, { headers })
            .then(response => response.text())
            .then(data => {
              document.getElementById("webhooks").innerHTML = data;
              bindWebhooksPagination();
            });
        };

        fetchAudits();
        fetchWebhooks();
      });
    </script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="m-3 p-3 main-card">
        <div class="d-flex flex-row bd-highlight mb-1 align-items-center">
          <div class="p-2 bd-highlight"><%= image_tag "logo.png", size: 90 %></div>
          <div class="p-2 bd-highlight">
            <h1 class="title-font m-0 inline">HerboMadrid</h1>
            <h3 class="title-font secondary-font-color m-0 inline"> # stock controller</h3>
            <h6>Provider catalog sync manager</h6>
          </div>
        </div>

        <hr/>

        <%# Products BEGIN %>
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex flex-row bd-highlight pt-3 pb-3 align-items-center">
              <div class="bd-highlight"><%= image_tag "product-icon.png", size: 60 %></div>
              <div class="bd-highlight">
                <h3 class="title-font m-0">Products</h3>
              </div>
            </div>
            <div class="m-2">
              <div id="products"><br>Loading...</div>
            </div>
          </div>
        </div>
        <%# Products END %>

        <div id="audits">
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex flex-row justify-content-center bd-highlight pt-3 pb-3 align-items-center">
                <div class="bd-highlight text-center">
                  <%= image_tag "loading.gif", size: 60 %>
                  <h6 class="title-font m-0">loading</h6>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="webhooks">
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex flex-row justify-content-center bd-highlight pt-3 pb-3 align-items-center">
                <div class="bd-highlight text-center">
                  <%= image_tag "loading.gif", size: 60 %>
                  <h6 class="title-font m-0">loading</h6>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
